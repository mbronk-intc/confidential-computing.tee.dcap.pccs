#!/usr/bin/env bash
# postinst script for intel-tee-pccs-admin-tool
#
# see: dh_installdeb(1)

set -euo pipefail

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


# Note: Consider https://dh-virtualenv.readthedocs.io/en/latest/usage.html instead of manually creating venv

PACKAGE_PATH=@pkg_path@
VENV_DIR="$PACKAGE_PATH/venv"
MAIN_SCRIPT_NAME=@main_script_name@
WRAPPER_SCRIPT_NAME=@pkg_wrapper_script_name@

function on_pip_error() {
    error_code=$?
    if [[ "${pip_output:-}" == *Network* ]] || [[ "${pip_output:-}" == *ProxyError* ]] || [[ "${pip_output:-}" == *NewConnectionError* ]] || [[ "${pip_output:-}" == *SSLError* ]]; then
        echo -e "ERROR: 'pip install' failed with exit code $error_code. See the output above for details.\n"
        echo "Note: If the issue is network-related and you are behind a network proxy, please check your system configuration (e.g., proxy related environment variables)."
        echo "      For example, try retrying the command with explicit proxy, i.e. #> https_proxy=http://proxy.example.com:1234 apt install intel-tee-pccs-admin-tool"
        echo "      For more information, see: https://pip.pypa.io/en/stable/user_guide/#using-a-proxy-server"
        echo "      Detected proxy variables: 'http_proxy': [${http_proxy:-not set}] | 'https_proxy': [${https_proxy:-not set}] | 'no_proxy': [${no_proxy:-not set}] | 'PIP_PROXY': [${PIP_PROXY:-not set}]"        
    fi
    exit ${error_code}
}


function create_venv {
    echo "Creating virtual environment..."
    python3 -m venv "$VENV_DIR"

    echo "Activating virtual environment and installing dependencies..."
    source "$VENV_DIR/bin/activate"

    OUT_STREAM=$( [ -t 1 ] && [ -e /dev/tty ] && [ -w /dev/tty ] && echo /dev/tty || echo /dev/stderr )
    trap 'on_pip_error' ERR  # To inject extra error handling for proxy

    # Deliberately set low timeouts and retries to avoid long hangs during installation (overridable via env vars)
    export PIP_TIMEOUT=${PIP_TIMEOUT:-5}
    export PIP_RETRIES=${PIP_RETRIES:-1}

    pip_output=$(pip install --no-input --require-virtualenv --upgrade pip 2>&1 | tee ${OUT_STREAM})
    pip_output=$(pip install --no-input --require-virtualenv --upgrade setuptools wheel 2>&1 | tee ${OUT_STREAM})

    echo "Installing required Python packages:"
    cat "${PACKAGE_PATH}/requirements.txt"
    pip_output=$(pip install --no-input --require-virtualenv -r "${PACKAGE_PATH}/requirements.txt" 2>&1 | tee ${OUT_STREAM})

    trap - ERR

    echo "Virtual environment setup complete."
}

function create_wrapper_script {
    WRAPPER_SCRIPT_PATH="$PACKAGE_PATH/$WRAPPER_SCRIPT_NAME"
    echo -n "Creating wrapper script at '$WRAPPER_SCRIPT_PATH' and linking to /usr/local/bin/..."

    cat <<EOF > "$WRAPPER_SCRIPT_PATH"
#!/usr/bin/env bash
source "$VENV_DIR/bin/activate"
PCCS_ADMIN_TOOL_EXECUTABLE_WRAPPER=$WRAPPER_SCRIPT_NAME PYTHONPYCACHEPREFIX="${VENV_DIR}/__pycache__" python "$PACKAGE_PATH/$MAIN_SCRIPT_NAME" "\$@"
EOF

    chmod +x "$WRAPPER_SCRIPT_PATH"
    # Add the wrapper script to a directory in the user's PATH, e.g., /usr/local/bin
    ln -sf "$PACKAGE_PATH/$WRAPPER_SCRIPT_NAME" /usr/local/bin/$WRAPPER_SCRIPT_NAME
    echo "DONE"
    echo "Installation successful. Run \`pccs-admin-tool\` to start using the tool."
}


case "$1" in
    configure)
        create_venv
        create_wrapper_script        
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac


# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
